<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 核心：HTML5 移动端视口设置，禁止缩放 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>托福词汇挑战 (自适应对齐版)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #334155;
            --success: #10b981;
            --error: #ef4444;
            --header-height: 60px;
            --footer-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            /* 核心：使用 dvh 适配移动端动态地址栏高度 */
            height: 100vh; 
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* === 顶部仪表盘 === */
        header {
            height: var(--header-height);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 10;
            flex-shrink: 0;
        }

        .title { font-size: 18px; font-weight: 800; color: var(--primary); }
        .stats { font-size: 14px; color: #64748b; font-weight: 600; }

        #progress-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: transparent;
        }
        #progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; }

        /* === 游戏滚动区域 === */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 120px; /* 留出足够空间给底部按钮，防止遮挡 */
            -webkit-overflow-scrolling: touch;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 两列等宽 */
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .col-header {
            text-align: center; color: #94a3b8; font-size: 12px; 
            text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px;
        }

        /* === 卡片样式 (核心修改部分) === */
        .card {
            background: var(--card-bg);
            border-radius: 10px;
            /* === 关键修改：固定高度实现对齐 === */
            height: 90px; 
            
            /* Flex布局保证文字垂直居中 */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            
            padding: 5px 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 2px solid transparent;
            transition: all 0.15s ease;
            cursor: pointer;
            overflow: hidden; /* 防止文字溢出 */
        }

        /* 英文单词字体稍大 */
        .card.en {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            font-family: 'Georgia', serif; /* 英文用衬线体更好辨识 */
        }

        /* 中文解释字体稍小，行高紧凑 */
        .card.zh {
            font-size: 13px;
            color: #475569;
            line-height: 1.3;
        }

        .card:active { transform: scale(0.96); background: #f8fafc; }

        .card.selected {
            border-color: var(--primary);
            background-color: #eef2ff;
            color: var(--primary);
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }

        .card.matched {
            opacity: 0; pointer-events: none; transform: scale(0.8); transition: transform 0.3s, opacity 0.3s;
        }

        .card.wrong {
            background-color: #fef2f2; border-color: var(--error); color: var(--error);
            animation: shake 0.4s;
        }
        
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

        /* === 底部固定操作区 === */
        footer {
            flex-shrink: 0;
            background: linear-gradient(to top, #f1f5f9 85%, rgba(241, 245, 249, 0));
            padding: 10px 20px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
            text-align: center;
            pointer-events: none;
            position: absolute;
            bottom: 0; width: 100%;
            z-index: 20;
        }

        .btn {
            pointer-events: auto;
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 0;
            width: 100%;
            max-width: 400px;
            border-radius: 12px; /* 稍微方一点 */
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
            display: none;
            cursor: pointer;
        }
        .btn:active { transform: scale(0.98); }

        /* === 加载遮罩 === */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0;
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: var(--error); text-align: center; padding: 20px; line-height: 1.6; }
    </style>
</head>
<body>

    <!-- 加载界面 -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div id="loading-text" style="color:#64748b; font-size:14px;">正在加载题库...</div>
    </div>

    <!-- 顶部固定 -->
    <header>
        <div class="title">TOEFL Match</div>
        <div class="stats">剩余: <span id="left-count">--</span></div>
        <div id="progress-container"><div id="progress-bar"></div></div>
    </header>

    <!-- 中间滚动 -->
    <main>
        <div class="grid-container">
            <!-- 左列：英文 -->
            <div class="column">
                <div class="col-header">Word</div>
                <div id="col-en" style="display:grid; gap:10px;"></div>
            </div>
            <!-- 右列：中文 -->
            <div class="column">
                <div class="col-header">Meaning</div>
                <div id="col-zh" style="display:grid; gap:10px;"></div>
            </div>
        </div>
    </main>

    <!-- 底部固定 -->
    <footer>
        <button class="btn" id="next-btn" onclick="nextLevel()">下一组 (Next Level)</button>
    </footer>

    <script>
        // ============================================================
        // API 设置
        // ============================================================
        const API_URL = "https://api.npoint.io/ef9cd015292eaa3ac09b"; 

        let fullLibrary = []; 
        let gamePool = [];    
        let currentRound = []; 
        let matches = 0;
        let selectedEn = null, selectedZh = null;
        let isProcessing = false; 

        // 1. 程序入口
        async function init() {
            const loadingText = document.getElementById('loading-text');
            const spinner = document.querySelector('.spinner');
            
            try {
                const res = await fetch(API_URL);
                if(!res.ok) throw new Error("网络异常: " + res.status);
                
                const data = await res.json();
                
                // 数据智能适配
                let dataArray = [];
                if (Array.isArray(data)) {
                    dataArray = data;
                } else if (typeof data === 'object' && data !== null) {
                    dataArray = data.words || data.list || data.data || Object.values(data);
                }

                if (!Array.isArray(dataArray) || dataArray.length === 0) {
                    throw new Error("无法识别数据格式");
                }

                // 数据清洗
                fullLibrary = dataArray.map(item => {
                    if(Array.isArray(item)) return { en: item[0], zh: item[1] };
                    if(item.en && item.zh) return item;
                    return null;
                }).filter(i => i);

                document.getElementById('loading-screen').style.display = 'none';
                startGame();

            } catch (err) {
                console.error(err);
                spinner.style.display = 'none';
                loadingText.innerHTML = `<div class="error-msg">加载失败<br>${err.message}<br><br><u onclick="location.reload()">点击重试</u></div>`;
            }
        }

        function startGame() {
            gamePool = [...fullLibrary];
            shuffle(gamePool);
            updateStats();
            loadLevel();
        }

        function loadLevel() {
            document.getElementById('next-btn').style.display = 'none';
            matches = 0;
            selectedEn = null; selectedZh = null;

            if (gamePool.length === 0) {
                alert("通关！所有单词已完成！");
                return;
            }

            // 每次取 8 个 (手机屏幕通常放8个刚好)
            const count = Math.min(8, gamePool.length);
            currentRound = gamePool.splice(0, count);
            updateStats();

            const colEn = document.getElementById('col-en');
            const colZh = document.getElementById('col-zh');
            colEn.innerHTML = ''; colZh.innerHTML = '';

            let listEn = currentRound.map(i => ({id: i.en, text: i.en, type: 'en'}));
            let listZh = currentRound.map(i => ({id: i.en, text: i.zh, type: 'zh'}));
            
            shuffle(listEn);
            shuffle(listZh);

            listEn.forEach(d => colEn.appendChild(createCard(d)));
            listZh.forEach(d => colZh.appendChild(createCard(d)));
        }

        function createCard(data) {
            const div = document.createElement('div');
            // 区别中英文样式
            div.className = `card ${data.type}`; 
            div.innerText = data.text;
            div.dataset.id = data.id;
            div.dataset.type = data.type;
            div.onclick = () => handleTap(div);
            return div;
        }

        function handleTap(el) {
            if (isProcessing || el.classList.contains('matched') || el.classList.contains('selected')) return;

            // 震动反馈
            if (navigator.vibrate) navigator.vibrate(5);

            el.classList.add('selected');
            
            if (el.dataset.type === 'en') {
                if (selectedEn) selectedEn.classList.remove('selected');
                selectedEn = el;
            } else {
                if (selectedZh) selectedZh.classList.remove('selected');
                selectedZh = el;
            }

            if (selectedEn && selectedZh) checkMatch();
        }

        function checkMatch() {
            isProcessing = true;
            const isMatch = selectedEn.dataset.id === selectedZh.dataset.id;

            if (isMatch) {
                matches++;
                selectedEn.classList.replace('selected', 'matched');
                selectedZh.classList.replace('selected', 'matched');
                
                selectedEn = null; selectedZh = null;
                isProcessing = false;

                if (matches === currentRound.length) {
                    document.getElementById('next-btn').style.display = 'block';
                    // 平滑滚动到底部
                    setTimeout(() => {
                        document.querySelector('main').scrollTo({ top: 9999, behavior: 'smooth' });
                    }, 200);
                }
            } else {
                selectedEn.classList.add('wrong');
                selectedZh.classList.add('wrong');
                if (navigator.vibrate) navigator.vibrate([30, 30, 30]);

                setTimeout(() => {
                    selectedEn.classList.remove('selected', 'wrong');
                    selectedZh.classList.remove('selected', 'wrong');
                    selectedEn = null; selectedZh = null;
                    isProcessing = false;
                }, 400);
            }
        }

        window.nextLevel = function() {
            loadLevel();
            document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateStats() {
            document.getElementById('left-count').innerText = gamePool.length;
            const total = fullLibrary.length;
            const pct = total > 0 ? ((total - gamePool.length) / total) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }

        function shuffle(arr) {
            arr.sort(() => Math.random() - 0.5);
        }

        init();

    </script>
</body>
</html>

