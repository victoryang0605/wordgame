<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- æ ¸å¿ƒï¼šç§»åŠ¨ç«¯é€‚é… -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ‰˜ç¦è¯æ±‡ç‰¹è®­ Pro (å¸¦æŸ¥æ‰¾åŠŸèƒ½)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #334155;
            --success: #10b981;
            --error: #ef4444;
            --header-height: 65px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* === é¡¶éƒ¨ä»ªè¡¨ç›˜ === */
        header {
            height: var(--header-height);
            background: rgba(255, 255, 255, 0.98);
            padding: 0 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            z-index: 50;
            flex-shrink: 0;
            gap: 8px;
        }

        /* 1. å·¦ä¾§é”™è¯¯ç‡ */
        .stat-box {
            font-size: 12px; font-weight: 600; color: #64748b;
            display: flex; align-items: center; min-width: 45px;
        }
        .error-text { color: var(--error); }

        /* 2. ä¸­é—´æœç´¢æ  (æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹ä¸º Flex è¡¨å•å¸ƒå±€) */
        .search-form {
            flex: 1;
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 2px 4px 2px 12px; /* å³ä¾§ç•™ç»™æŒ‰é’® */
            transition: all 0.2s;
        }
        .search-form:focus-within {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }
        #search-input {
            border: none; background: transparent; width: 100%;
            font-size: 13px; color: #334155; padding: 6px 0;
        }
        .search-btn {
            background: var(--primary); color: white; border: none;
            border-radius: 50%; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0; font-size: 14px;
            margin-left: 5px;
        }

        /* 3. å³ä¾§è®¡æ—¶å™¨ */
        .timer-box {
            font-size: 12px; font-weight: 600; color: var(--primary);
            font-variant-numeric: tabular-nums; min-width: 40px; text-align: right;
        }

        /* è¿›åº¦æ¡ */
        #progress-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: transparent;
        }
        #progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; }

        /* === æ¸¸æˆåŒºåŸŸ === */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 100px;
            -webkit-overflow-scrolling: touch;
        }

        .grid-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            max-width: 600px; margin: 0 auto;
        }

        .col-header {
            text-align: center; color: #94a3b8; font-size: 12px; 
            text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px;
        }

        .card {
            background: var(--card-bg); border-radius: 10px; height: 90px;
            display: flex; align-items: center; justify-content: center; text-align: center;
            padding: 5px 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 2px solid transparent; transition: all 0.15s ease; cursor: pointer; overflow: hidden;
        }
        .card.en { font-size: 16px; font-weight: 600; color: #1e293b; font-family: 'Georgia', serif; }
        .card.zh { font-size: 13px; color: #475569; line-height: 1.3; }
        .card:active { transform: scale(0.96); background: #f8fafc; }
        .card.selected { border-color: var(--primary); background-color: #eef2ff; color: var(--primary); font-weight: bold; }
        .card.matched { opacity: 0; pointer-events: none; transform: scale(0.8); }
        .card.wrong { background-color: #fef2f2; border-color: var(--error); color: var(--error); animation: shake 0.4s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

        /* === åº•éƒ¨æŒ‰é’® === */
        footer {
            flex-shrink: 0; background: linear-gradient(to top, #f1f5f9 85%, rgba(241, 245, 249, 0));
            padding: 10px 20px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
            text-align: center; pointer-events: none; position: absolute; bottom: 0; width: 100%; z-index: 20;
        }
        .btn {
            pointer-events: auto; background: var(--primary); color: white; border: none; padding: 14px 0; width: 100%; max-width: 400px;
            border-radius: 12px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); display: none; cursor: pointer;
        }

        /* === å¼¹çª— === */
        #search-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; width: 85%; max-width: 320px; border-radius: 16px; padding: 25px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: popIn 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-word { font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 10px; font-family: 'Georgia', serif;}
        .modal-def { font-size: 16px; color: #475569; line-height: 1.5; margin-bottom: 20px; white-space: pre-wrap; }
        .modal-btn { background: #e2e8f0; color: #475569; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; }

        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- å¼¹çª— -->
    <div id="search-modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modal-word" class="modal-word"></div>
            <div id="modal-def" class="modal-def"></div>
            <button class="modal-btn" onclick="closeModal()">å…³é—­</button>
        </div>
    </div>

    <!-- åŠ è½½ -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div id="loading-text" style="color:#64748b; font-size:14px;">æ­£åœ¨åŠ è½½é¢˜åº“...</div>
    </div>

    <header>
        <div class="stat-box">
            âŒ <span id="error-rate-display" style="margin-left:4px">0/0</span>
        </div>

        <!-- æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ form æ ‡ç­¾åŒ…è£¹ï¼Œç¡®ä¿ç§»åŠ¨ç«¯é”®ç›˜ "æœç´¢/Enter" é”®ç”Ÿæ•ˆ -->
        <form class="search-form" action="javascript:void(0);" onsubmit="submitSearch()">
            <input type="search" id="search-input" placeholder="å…¨åº“æœè¯..." autocomplete="off">
            <!-- æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ æ˜¾å¼çš„æœç´¢æŒ‰é’® -->
            <button type="submit" class="search-btn">ğŸ”</button>
        </form>

        <div class="timer-box">
            â± <span id="timer-display">00:00</span>
        </div>
        <div id="progress-container"><div id="progress-bar"></div></div>
    </header>

    <main>
        <div class="grid-container">
            <div class="column">
                <div class="col-header">Word</div>
                <div id="col-en" style="display:grid; gap:10px;"></div>
            </div>
            <div class="column">
                <div class="col-header">Meaning</div>
                <div id="col-zh" style="display:grid; gap:10px;"></div>
            </div>
        </div>
    </main>

    <footer>
        <button class="btn" id="next-btn" onclick="nextLevel()">ä¸‹ä¸€ç»„ (Next Level)</button>
    </footer>

    <script>
        // ==================================================================
        // è¯·ç¡®ä¿è¿™ä¸ª API åœ°å€è¿”å›çš„æ˜¯ä½ å®Œæ•´çš„ 3500 è¯ JSON
        // æ¼”ç¤ºåœ°å€ä»…åŒ…å«å°‘é‡å•è¯ï¼Œè¯·åŠ¡å¿…æ›¿æ¢ä¸ºä½ è‡ªå·±çš„å®Œæ•´ JSON URL
        // ==================================================================
        const API_URL = "https://api.npoint.io/702ced1a5f26783b1954"; 

        let fullLibrary = []; // æ€»é¢˜åº“ (åªè¯»)
        let gamePool = [];    // æ¸¸æˆæ±  (ä¼šè¢«æ¶ˆè€—)
        let currentRound = []; 
        let matches = 0;
        let selectedEn = null, selectedZh = null;
        let isProcessing = false; 

        // ç»Ÿè®¡å˜é‡
        let totalAttempts = 0; 
        let totalErrors = 0;
        let timerInterval = null;
        let secondsElapsed = 0;

        async function init() {
            const loadingText = document.getElementById('loading-text');
            try {
                loadingText.innerText = "æ­£åœ¨ä¸‹è½½è¯åº“...";
                const res = await fetch(API_URL);
                if(!res.ok) throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
                const data = await res.json();
                
                // æ•°æ®é€‚é…
                let dataArray = [];
                if (Array.isArray(data)) dataArray = data;
                else if (typeof data === 'object') dataArray = data.words || data.list || Object.values(data);
                
                // æ ¸å¿ƒä¿®å¤ï¼šæ¸…æ´—æ•°æ®æ—¶ï¼ŒTrim å»é™¤é¦–å°¾ç©ºæ ¼ï¼Œç¡®ä¿æœç´¢ç²¾å‡†
                fullLibrary = dataArray.map(item => {
                    let en, zh;
                    if(Array.isArray(item)) { en = item[0]; zh = item[1]; }
                    else { en = item.en; zh = item.zh; }
                    
                    if(en && zh) {
                        return { 
                            en: String(en).trim(), 
                            zh: String(zh).trim() 
                        };
                    }
                    return null;
                }).filter(i => i);

                console.log(`è¯åº“åŠ è½½å®Œæˆï¼Œå…± ${fullLibrary.length} ä¸ªå•è¯`);
                document.getElementById('loading-screen').style.display = 'none';
                
                startGame();

            } catch (err) {
                loadingText.innerHTML = `åŠ è½½å¤±è´¥: ${err.message} <br><br> <u onclick="location.reload()">ç‚¹å‡»åˆ·æ–°</u>`;
            }
        }

        function startGame() {
            // æ·±åº¦å¤åˆ¶ï¼Œç¡®ä¿æ¸¸æˆé€»è¾‘ä¸å½±å“ fullLibrary æœç´¢
            gamePool = JSON.parse(JSON.stringify(fullLibrary));
            shuffle(gamePool);
            updateStats();
            startTimer();
            loadLevel();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            secondsElapsed = 0;
            timerInterval = setInterval(() => {
                secondsElapsed++;
                const m = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
                const s = (secondsElapsed % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `${m}:${s}`;
            }, 1000);
        }

        // === æ ¸å¿ƒä¿®å¤ï¼šæœç´¢åŠŸèƒ½ ===
        function submitSearch() {
            const input = document.getElementById('search-input');
            const query = input.value;
            // é”®ç›˜æ”¶èµ·
            input.blur();
            handleSearch(query);
        }

        function handleSearch(query) {
            query = query.trim().toLowerCase();
            if (!query) return;

            // 1. ç²¾ç¡®æœç´¢
            let result = fullLibrary.find(w => w.en.toLowerCase() === query);
            
            // 2. å¦‚æœç²¾ç¡®æ²¡æ‰¾åˆ°ï¼Œå°è¯•å‰ç¼€æœç´¢ (æ¯”å¦‚è¾“å…¥ aband æ‰¾åˆ° abandon)
            if (!result) {
                result = fullLibrary.find(w => w.en.toLowerCase().startsWith(query));
            }

            // 3. å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œå°è¯•æ¨¡ç³ŠåŒ…å« (æ¯”å¦‚è¾“å…¥ band æ‰¾åˆ° abandon)
            if (!result) {
                result = fullLibrary.find(w => w.en.toLowerCase().includes(query));
            }

            if (result) {
                showModal(result.en, result.zh);
            } else {
                // æç¤ºæœç´¢èŒƒå›´
                showModal("æœªæ‰¾åˆ°", `åœ¨ ${fullLibrary.length} ä¸ªå•è¯ä¸­æœªæ‰¾åˆ° "${query}"ã€‚\nè¯·æ£€æŸ¥æ‹¼å†™æˆ–ç¡®è®¤ JSON æ–‡ä»¶æ˜¯å¦åŒ…å«è¯¥è¯ã€‚`);
            }

            // æ¸…ç©ºè¾“å…¥
            document.getElementById('search-input').value = '';
        }

        function showModal(word, def) {
            document.getElementById('modal-word').innerText = word;
            document.getElementById('modal-def').innerText = def;
            document.getElementById('search-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('search-modal').style.display = 'none';
        }

        // === æ¸¸æˆä¸»ä½“é€»è¾‘ ===
        function loadLevel() {
            document.getElementById('next-btn').style.display = 'none';
            matches = 0;
            selectedEn = null; selectedZh = null;

            if (gamePool.length === 0) {
                alert("æ­å–œï¼æ‰€æœ‰å•è¯å·²å®Œæˆï¼");
                return;
            }

            const count = Math.min(8, gamePool.length);
            currentRound = gamePool.splice(0, count);
            updateStats();

            const colEn = document.getElementById('col-en');
            const colZh = document.getElementById('col-zh');
            colEn.innerHTML = ''; colZh.innerHTML = '';

            let listEn = currentRound.map(i => ({id: i.en, text: i.en, type: 'en'}));
            let listZh = currentRound.map(i => ({id: i.en, text: i.zh, type: 'zh'}));
            
            shuffle(listEn);
            shuffle(listZh);

            listEn.forEach(d => colEn.appendChild(createCard(d)));
            listZh.forEach(d => colZh.appendChild(createCard(d)));
        }

        function createCard(data) {
            const div = document.createElement('div');
            div.className = `card ${data.type}`;
            div.innerText = data.text;
            div.dataset.id = data.id;
            div.dataset.type = data.type;
            div.onclick = () => handleTap(div);
            return div;
        }

        function handleTap(el) {
            if (isProcessing || el.classList.contains('matched') || el.classList.contains('selected')) return;
            if (navigator.vibrate) navigator.vibrate(5);

            el.classList.add('selected');
            
            if (el.dataset.type === 'en') {
                if (selectedEn) selectedEn.classList.remove('selected');
                selectedEn = el;
            } else {
                if (selectedZh) selectedZh.classList.remove('selected');
                selectedZh = el;
            }

            if (selectedEn && selectedZh) checkMatch();
        }

        function checkMatch() {
            isProcessing = true;
            const isMatch = selectedEn.dataset.id === selectedZh.dataset.id;
            totalAttempts++; 
            if (!isMatch) totalErrors++;
            updateErrorStats();

            if (isMatch) {
                matches++;
                selectedEn.classList.replace('selected', 'matched');
                selectedZh.classList.replace('selected', 'matched');
                selectedEn = null; selectedZh = null;
                isProcessing = false;

                if (matches === currentRound.length) {
                    document.getElementById('next-btn').style.display = 'block';
                    setTimeout(() => {
                        document.querySelector('main').scrollTo({ top: 9999, behavior: 'smooth' });
                    }, 200);
                }
            } else {
                selectedEn.classList.add('wrong');
                selectedZh.classList.add('wrong');
                if (navigator.vibrate) navigator.vibrate(50);

                setTimeout(() => {
                    selectedEn.classList.remove('selected', 'wrong');
                    selectedZh.classList.remove('selected', 'wrong');
                    selectedEn = null; selectedZh = null;
                    isProcessing = false;
                }, 400);
            }
        }

        function updateErrorStats() {
            const el = document.getElementById('error-rate-display');
            el.innerText = `${totalErrors}/${totalAttempts}`;
            if (totalErrors > 0) el.classList.add('error-text');
        }

        window.nextLevel = function() {
            loadLevel();
            document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateStats() {
            const total = fullLibrary.length;
            const pct = total > 0 ? ((total - gamePool.length) / total) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }

        function shuffle(arr) {
            arr.sort(() => Math.random() - 0.5);
        }

        init();
    </script>
</body>
</html>
