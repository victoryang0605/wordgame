<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÊâòÁ¶èËØçÊ±áÁâπËÆ≠ Pro (‰∏ì‰∏öÂèçÈ¶àÁâà)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #334155;
            --success: #10b981;
            --error: #ef4444;
            --header-height: 65px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0; height: 100dvh; 
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* Header Styles */
        header {
            height: var(--header-height); background: rgba(255, 255, 255, 0.98);
            padding: 0 10px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 50; flex-shrink: 0; gap: 6px;
        }
        .stat-box { font-size: 12px; font-weight: 600; color: #64748b; display: flex; align-items: center; min-width: 40px; }
        .error-text { color: var(--error); }
        
        .search-form {
            flex: 1; display: flex; align-items: center; background: #f8fafc;
            border: 1px solid #e2e8f0; border-radius: 20px; padding: 2px 4px 2px 10px;
            transition: all 0.2s; max-width: 45%;
        }
        .search-form:focus-within { border-color: var(--primary); background: white; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1); }
        #search-input { border: none; background: transparent; width: 100%; font-size: 13px; color: #334155; padding: 6px 0; }
        .search-btn {
            background: var(--primary); color: white; border: none; border-radius: 50%; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; font-size: 14px; margin-left: 4px;
        }

        .info-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; font-size: 11px; min-width: 70px; line-height: 1.4; }
        .total-num { font-weight: 800; color: var(--primary); font-size: 12px; }
        .timer-box { font-weight: 600; color: #64748b; font-variant-numeric: tabular-nums; }
        
        #progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: transparent; }
        #progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; }

        /* Main & Grid */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 600px; margin: 0 auto; }
        .col-header { text-align: center; color: #94a3b8; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px; }

        .card {
            background: var(--card-bg); border-radius: 10px; height: 90px;
            display: flex; align-items: center; justify-content: center; text-align: center;
            padding: 5px 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 2px solid transparent;
            transition: all 0.15s ease; cursor: pointer; overflow: hidden;
        }
        .card.en { font-size: 16px; font-weight: 600; color: #1e293b; font-family: 'Georgia', serif; }
        .card.zh { font-size: 13px; color: #475569; line-height: 1.3; }
        .card:active { transform: scale(0.96); background: #f8fafc; }
        .card.selected { border-color: var(--primary); background-color: #eef2ff; color: var(--primary); font-weight: bold; }
        .card.matched { opacity: 0; pointer-events: none; transform: scale(0.8); }
        .card.wrong { background-color: #fef2f2; border-color: var(--error); color: var(--error); animation: shake 0.4s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

        /* Footer & Buttons */
        footer {
            flex-shrink: 0; background: linear-gradient(to top, #f1f5f9 85%, rgba(241, 245, 249, 0));
            padding: 10px 20px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
            text-align: center; pointer-events: none; position: absolute; bottom: 0; width: 100%; z-index: 20;
        }
        .btn {
            pointer-events: auto; background: var(--primary); color: white; border: none; padding: 14px 0; width: 100%; max-width: 400px;
            border-radius: 12px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); display: none; cursor: pointer;
        }

        /* ÂèçÈ¶àÂÖ•Âè£ */
        .feedback-trigger { text-align: center; margin-top: 30px; padding-bottom: 10px; }
        .feedback-link { font-size: 12px; color: #94a3b8; text-decoration: none; cursor: pointer; border-bottom: 1px dashed #cbd5e1; padding-bottom: 2px; }
        
        /* ÂºπÁ™óÈÄöÁî® */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; width: 85%; max-width: 320px; border-radius: 16px; padding: 25px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: popIn 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* ÊêúÁ¥¢ÂºπÁ™ó */
        .modal-word { font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 10px; font-family: 'Georgia', serif;}
        .modal-def { font-size: 16px; color: #475569; line-height: 1.5; margin-bottom: 20px; white-space: pre-wrap; }
        
        /* ÂèçÈ¶àÂºπÁ™ó */
        .star-rating { font-size: 28px; color: #e2e8f0; margin-bottom: 15px; cursor: pointer; }
        .star-rating span.active { color: #fbbf24; }
        #feedback-text { 
            width: 100%; height: 80px; border: 1px solid #e2e8f0; border-radius: 8px; 
            padding: 10px; font-size: 14px; margin-bottom: 15px; resize: none; font-family: inherit;
        }
        #feedback-text:focus { border-color: var(--primary); }
        
        .modal-btn { background: #e2e8f0; color: #475569; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 5px;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.7; }

        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- 1. ÊêúÁ¥¢ÂºπÁ™ó -->
    <div id="search-modal" class="modal-overlay" onclick="closeModal('search-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modal-word" class="modal-word"></div>
            <div id="modal-def" class="modal-def"></div>
            <button class="modal-btn" onclick="closeModal('search-modal')">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <!-- 2. ÂèçÈ¶àÂºπÁ™ó (Âü∫‰∫é Formspree) -->
    <div id="feedback-modal" class="modal-overlay" onclick="closeModal('feedback-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin:0 0 15px 0; color:#334155;">üìù ÁïôË®ÄËØÑ‰ª∑</h3>
            
            <!-- ÊòüÊòüËØÑÂàÜ -->
            <div class="star-rating" id="star-container">
                <span data-val="1">‚òÖ</span><span data-val="2">‚òÖ</span><span data-val="3">‚òÖ</span><span data-val="4">‚òÖ</span><span data-val="5">‚òÖ</span>
            </div>
            
            <textarea id="feedback-text" name="message" placeholder="ËØ∑ÂÜô‰∏ãÊÇ®ÁöÑÂª∫ËÆÆÊàñBugÂèçÈ¶à..."></textarea>
            
            <!-- ËøôÈáåÁöÑÊåâÈíÆËß¶Âèë AJAX Êèê‰∫§ -->
            <button id="submit-fb-btn" class="modal-btn btn-primary" onclick="submitFeedback()">Êèê‰∫§ÂèçÈ¶à</button>
            <button class="modal-btn" style="margin-top:8px; background:transparent;" onclick="closeModal('feedback-modal')">ÂèñÊ∂à</button>
        </div>
    </div>

    <!-- Âä†ËΩΩ -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div id="loading-text" style="color:#64748b; font-size:14px;">Ê≠£Âú®Âä†ËΩΩÈ¢òÂ∫ì...</div>
    </div>

    <header>
        <div class="stat-box">‚ùå <span id="error-rate-display" style="margin-left:4px">0/0</span></div>
        <form class="search-form" action="javascript:void(0);" onsubmit="submitSearch()">
            <input type="search" id="search-input" placeholder="ËØ∑ËæìÂÖ•‰Ω†Ë¶ÅÊü•ÊâæÁöÑÂçïËØç..." autocomplete="off">
            <button type="submit" class="search-btn">üîç</button>
        </form>
        <div class="info-right">
            <div class="total-count-box">Total: <span id="total-count-display" class="total-num">--</span></div>
            <div class="timer-box">‚è± <span id="timer-display">00:00</span></div>
        </div>
        <div id="progress-container"><div id="progress-bar"></div></div>
    </header>

    <main>
        <div class="grid-container">
            <div class="column">
                <div class="col-header">Word</div>
                <div id="col-en" style="display:grid; gap:10px;"></div>
            </div>
            <div class="column">
                <div class="col-header">Meaning</div>
                <div id="col-zh" style="display:grid; gap:10px;"></div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÂèçÈ¶àÂÖ•Âè£ -->
        <div class="feedback-trigger">
            <span class="feedback-link" onclick="openFeedback()">‚úçÔ∏è Êèê‰∫§ÂèçÈ¶à / ËØÑ‰ª∑</span>
        </div>
    </main>

    <footer>
        <button class="btn" id="next-btn" onclick="nextLevel()">‰∏ã‰∏ÄÁªÑ (Next Level)</button>
    </footer>

    <script>
        // ==================================================================
        // Ê†∏ÂøÉÈÖçÁΩÆÂå∫
        // ==================================================================
        const WORD_API = "https://api.npoint.io/ef9cd015292eaa3ac09b"; 
        
        // ‚òÖ‚òÖ‚òÖ ËØ∑Â∞Ü‰∏ãÊñπ 'YOUR_FORM_ID' ÊõøÊç¢‰∏∫‰Ω†Âú® Formspree Ëé∑ÂèñÁöÑ ID ‚òÖ‚òÖ‚òÖ
        // ‰æãÂ¶Ç: const FORMSPREE_ENDPOINT = "https://formspree.io/f/xxyyzzaa";
        const FORMSPREE_ENDPOINT = "https://formspree.io/f/xjklqldr";

        // ==================================================================

        let fullLibrary = []; let gamePool = []; let currentRound = []; 
        let matches = 0; let selectedEn = null, selectedZh = null; let isProcessing = false; 
        let totalAttempts = 0; let totalErrors = 0;
        let timerInterval = null; let secondsElapsed = 0;

        // ÂèçÈ¶àÁõ∏ÂÖ≥ÂèòÈáè
        let currentRating = 5;

        async function init() {
            const loadingText = document.getElementById('loading-text');
            try {
                loadingText.innerText = "Ê≠£Âú®‰∏ãËΩΩÊï∞ÊçÆ...";
                const res = await fetch(WORD_API);
                if(!res.ok) throw new Error("ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•");
                let data = await res.json();
                
                let dataArray = [];
                if (Array.isArray(data)) dataArray = data;
                else if (typeof data === 'object') dataArray = data.words || data.list || Object.values(data);
                
                fullLibrary = dataArray.map(item => {
                    let en, zh;
                    if(Array.isArray(item)) { en = item[0]; zh = item[1]; }
                    else { en = item.en; zh = item.zh; }
                    if(en) {
                        return { en: String(en).trim(), zh: zh ? String(zh).trim() : "ÊöÇÊó†Èáä‰πâ" };
                    }
                    return null;
                }).filter(i => i);

                document.getElementById('total-count-display').innerText = fullLibrary.length;
                document.getElementById('loading-screen').style.display = 'none';
                
                initStarRating(); 
                startGame();

            } catch (err) {
                loadingText.innerHTML = `ÈîôËØØ: ${err.message} <br><br> <u onclick="location.reload()">ÁÇπÂáªÈáçËØï</u>`;
            }
        }

        function startGame() {
            gamePool = JSON.parse(JSON.stringify(fullLibrary));
            shuffle(gamePool);
            updateStats();
            startTimer();
            loadLevel();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            secondsElapsed = 0;
            timerInterval = setInterval(() => {
                secondsElapsed++;
                const m = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
                const s = (secondsElapsed % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `${m}:${s}`;
            }, 1000);
        }

        // === Ê†∏ÂøÉ‰øÆÊîπÔºö‰ΩøÁî® Formspree Êèê‰∫§ÂèçÈ¶à ===
        function openFeedback() {
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â°´‰∫Ü Formspree ID
            if (FORMSPREE_ENDPOINT.includes("YOUR_FORM_ID")) {
                alert("ËØ∑ÂÖàÂú®‰ª£Á†Å‰∏≠ÈÖçÁΩÆ Formspree IDÔºÅ");
                return;
            }
            document.getElementById('feedback-modal').style.display = 'flex';
            document.getElementById('feedback-text').focus();
        }

        function initStarRating() {
            const stars = document.querySelectorAll('#star-container span');
            stars.forEach(star => {
                star.onclick = function() {
                    currentRating = parseInt(this.dataset.val);
                    updateStars();
                }
            });
            updateStars();
        }

        function updateStars() {
            const stars = document.querySelectorAll('#star-container span');
            stars.forEach(s => {
                if(parseInt(s.dataset.val) <= currentRating) s.classList.add('active');
                else s.classList.remove('active');
            });
        }

        async function submitFeedback() {
            const text = document.getElementById('feedback-text').value.trim();
            const btn = document.getElementById('submit-fb-btn');
            
            if(!text) { alert("ËØ∑ÂÜôÁÇπ‰ªÄ‰πàÂêß~"); return; }

            btn.disabled = true;
            btn.innerText = "Ê≠£Âú®ÂèëÈÄÅ...";

            // ÊûÑÈÄ†Ë¶ÅÂèëÈÄÅÁöÑÊï∞ÊçÆ
            const feedbackData = {
                rating: currentRating + " Êòü", // ËØÑÂàÜ
                message: text,                 // ÁïôË®ÄÂÜÖÂÆπ
                device: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'Mobile' : 'PC',
                date: new Date().toLocaleString()
            };

            try {
                // ÂèëÈÄÅÂà∞ Formspree
                const response = await fetch(FORMSPREE_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify(feedbackData),
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert("ÊÑüË∞¢ÊÇ®ÁöÑÂèçÈ¶àÔºÅÊàë‰ª¨Â∑≤Êî∂Âà∞ÈÇÆ‰ª∂ÈÄöÁü•„ÄÇ");
                    document.getElementById('feedback-text').value = '';
                    closeModal('feedback-modal');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Êèê‰∫§Â§±Ë¥•");
                }
            } catch (err) {
                alert("ÂèëÈÄÅÂ§±Ë¥•: " + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.innerText = "Êèê‰∫§ÂèçÈ¶à";
            }
        }

        // === ÊêúÁ¥¢ÂäüËÉΩ ===
        function submitSearch() {
            const input = document.getElementById('search-input');
            const query = input.value;
            input.blur();
            handleSearch(query);
        }

        function handleSearch(query) {
            query = query.trim().toLowerCase();
            if (!query) return;

            let result = fullLibrary.find(w => w.en.toLowerCase() === query);
            if (!result) result = fullLibrary.find(w => w.en.toLowerCase().startsWith(query));
            if (!result) result = fullLibrary.find(w => w.en.toLowerCase().includes(query));

            if (result) {
                showModal('search-modal', result.en, result.zh);
            } else {
                showModal('search-modal', "Êú™ÊâæÂà∞", `Âú® ${fullLibrary.length} ‰∏™ÂçïËØç‰∏≠Êú™ÊâæÂà∞ "${query}"„ÄÇ`);
            }
            document.getElementById('search-input').value = '';
        }

        function showModal(id, word, def) {
            if(id === 'search-modal') {
                document.getElementById('modal-word').innerText = word;
                document.getElementById('modal-def').innerText = def;
            }
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // === Ê∏∏ÊàèÈÄªËæë ===
        function loadLevel() {
            document.getElementById('next-btn').style.display = 'none';
            matches = 0; selectedEn = null; selectedZh = null;

            if (gamePool.length === 0) { alert("ÊÅ≠ÂñúÔºÅÊâÄÊúâÂçïËØçÂ∑≤ÂÆåÊàêÔºÅ"); return; }

            const count = Math.min(8, gamePool.length);
            currentRound = gamePool.splice(0, count);
            updateStats();

            const colEn = document.getElementById('col-en');
            const colZh = document.getElementById('col-zh');
            colEn.innerHTML = ''; colZh.innerHTML = '';

            let listEn = currentRound.map(i => ({id: i.en, text: i.en, type: 'en'}));
            let listZh = currentRound.map(i => ({id: i.en, text: i.zh, type: 'zh'}));
            
            shuffle(listEn); shuffle(listZh);

            listEn.forEach(d => colEn.appendChild(createCard(d)));
            listZh.forEach(d => colZh.appendChild(createCard(d)));
        }

        function createCard(data) {
            const div = document.createElement('div');
            div.className = `card ${data.type}`;
