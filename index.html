<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ‰˜ç¦è¯æ±‡ç‰¹è®­ Pro (è¯­éŸ³è·Ÿè¯»ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #334155;
            --success: #10b981;
            --error: #ef4444;
            --header-height: 65px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0; height: 100dvh; 
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* Header */
        header {
            height: var(--header-height); background: rgba(255, 255, 255, 0.98);
            padding: 0 10px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 50; flex-shrink: 0; gap: 6px;
        }
        .stat-box { font-size: 12px; font-weight: 600; color: #64748b; display: flex; align-items: center; min-width: 40px; }
        .error-text { color: var(--error); }
        
        .search-form {
            flex: 1; display: flex; align-items: center; background: #f8fafc;
            border: 1px solid #e2e8f0; border-radius: 20px; padding: 2px 4px 2px 10px;
            transition: all 0.2s; max-width: 45%;
        }
        .search-form:focus-within { border-color: var(--primary); background: white; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1); }
        #search-input { border: none; background: transparent; width: 100%; font-size: 13px; color: #334155; padding: 6px 0; }
        .search-btn {
            background: var(--primary); color: white; border: none; border-radius: 50%; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; font-size: 14px; margin-left: 4px;
        }

        .info-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; font-size: 11px; min-width: 70px; line-height: 1.4; }
        .total-num { font-weight: 800; color: var(--primary); font-size: 12px; }
        .timer-box { font-weight: 600; color: #64748b; font-variant-numeric: tabular-nums; }
        
        #progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: transparent; }
        #progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; }

        /* Main */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; -webkit-overflow-scrolling: touch; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 600px; margin: 0 auto; }
        .col-header { text-align: center; color: #94a3b8; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px; }

        .card {
            background: var(--card-bg); border-radius: 10px; height: 90px;
            display: flex; align-items: center; justify-content: center; text-align: center;
            padding: 5px 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 2px solid transparent;
            transition: all 0.15s ease; cursor: pointer; overflow: hidden; position: relative;
        }
        .card.en { font-size: 16px; font-weight: 600; color: #1e293b; font-family: 'Georgia', serif; }
        .card.zh { font-size: 13px; color: #475569; line-height: 1.3; }
        .card:active { transform: scale(0.96); background: #f8fafc; }
        .card.selected { border-color: var(--primary); background-color: #eef2ff; color: var(--primary); font-weight: bold; }
        .card.matched { opacity: 0; pointer-events: none; transform: scale(0.8); }
        .card.wrong { background-color: #fef2f2; border-color: var(--error); color: var(--error); animation: shake 0.4s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

        /* Footer */
        footer {
            flex-shrink: 0; background: linear-gradient(to top, #f1f5f9 85%, rgba(241, 245, 249, 0));
            padding: 10px 20px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
            text-align: center; pointer-events: none; position: absolute; bottom: 0; width: 100%; z-index: 20;
        }
        .btn {
            pointer-events: auto; background: var(--primary); color: white; border: none; padding: 14px 0; width: 100%; max-width: 400px;
            border-radius: 12px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); display: none; cursor: pointer;
        }

        .feedback-trigger { text-align: center; margin-top: 30px; padding-bottom: 10px; }
        .feedback-link { font-size: 12px; color: #94a3b8; text-decoration: none; cursor: pointer; border-bottom: 1px dashed #cbd5e1; padding-bottom: 2px; }
        
        /* Modal Overlay */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; width: 85%; max-width: 320px; border-radius: 16px; padding: 25px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: popIn 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* === å­¦ä¹ å¡ç‰‡ (å«è¯­éŸ³) === */
        .modal-word { font-size: 28px; font-weight: bold; color: var(--primary); margin-bottom: 5px; font-family: 'Georgia', serif;}
        .modal-def { font-size: 16px; color: #475569; line-height: 1.5; margin-bottom: 20px; white-space: pre-wrap; }
        
        .audio-controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .audio-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
            transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        /* æ’­æ”¾æŒ‰é’® */
        .btn-listen { background: #e0e7ff; color: var(--primary); }
        .btn-listen:active { background: #c7d2fe; transform: scale(0.95); }
        
        /* å½•éŸ³æŒ‰é’® */
        .btn-speak { background: #fce7f3; color: #db2777; position: relative;}
        .btn-speak.listening { background: #db2777; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(219, 39, 119, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(219, 39, 119, 0); } 100% { box-shadow: 0 0 0 0 rgba(219, 39, 119, 0); } }

        .speak-feedback { height: 20px; font-size: 13px; color: #94a3b8; font-weight: 600; margin-bottom: 10px; }
        .speak-success { color: var(--success); }
        .speak-fail { color: var(--error); }

        .modal-close-btn { background: #f1f5f9; color: #64748b; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; }

        /* åé¦ˆå¼¹çª—æ ·å¼ */
        .star-rating { font-size: 28px; color: #e2e8f0; margin-bottom: 15px; cursor: pointer; }
        .star-rating span.active { color: #fbbf24; }
        #feedback-text { width: 100%; height: 80px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; font-size: 14px; margin-bottom: 15px; resize: none; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:disabled { background: #94a3b8; opacity: 0.7; }

        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- 1. å•è¯å­¦ä¹ å¼¹çª— (æŸ¥è¯/è·Ÿè¯») -->
    <div id="word-modal" class="modal-overlay" onclick="closeModal('word-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modal-word" class="modal-word">Word</div>
            <div id="modal-def" class="modal-def">Definition</div>
            
            <!-- è¯­éŸ³æ§åˆ¶åŒº -->
            <div class="speak-feedback" id="speak-msg">ç‚¹å‡»éº¦å…‹é£å¼€å§‹è·Ÿè¯»</div>
            <div class="audio-controls">
                <!-- æœ—è¯»æŒ‰é’® -->
                <button class="audio-btn btn-listen" onclick="playAudio()" title="å¬å‘éŸ³">
                    ğŸ”Š
                </button>
                <!-- è·Ÿè¯»æŒ‰é’® -->
                <button class="audio-btn btn-speak" id="mic-btn" onclick="toggleSpeech()" title="è¯­éŸ³è·Ÿè¯»">
                    ğŸ™ï¸
                </button>
            </div>

            <button class="modal-close-btn" onclick="closeModal('word-modal')">å…³é—­</button>
        </div>
    </div>

    <!-- 2. åé¦ˆå¼¹çª— -->
    <div id="feedback-modal" class="modal-overlay" onclick="closeModal('feedback-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin:0 0 15px 0; color:#334155;">ğŸ“ ç•™è¨€è¯„ä»·</h3>
            <div class="star-rating" id="star-container">
                <span data-val="1">â˜…</span><span data-val="2">â˜…</span><span data-val="3">â˜…</span><span data-val="4">â˜…</span><span data-val="5">â˜…</span>
            </div>
            <textarea id="feedback-text" name="message" placeholder="è¯·å†™ä¸‹æ‚¨çš„å»ºè®®æˆ–Bugåé¦ˆ..."></textarea>
            <button id="submit-fb-btn" class="modal-close-btn btn-primary" onclick="submitFeedback()">æäº¤åé¦ˆ</button>
            <button class="modal-close-btn" style="margin-top:8px; background:transparent;" onclick="closeModal('feedback-modal')">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- åŠ è½½ -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div id="loading-text" style="color:#64748b; font-size:14px;">æ­£åœ¨åŠ è½½é¢˜åº“...</div>
    </div>

    <header>
        <div class="stat-box">âŒ <span id="error-rate-display" style="margin-left:4px">0/0</span></div>
        <form class="search-form" action="javascript:void(0);" onsubmit="submitSearch()">
            <input type="search" id="search-input" placeholder="æœè¯ (æˆ–åœ¨ç½‘æ ¼é•¿æŒ‰)..." autocomplete="off">
            <button type="submit" class="search-btn">ğŸ”</button>
        </form>
        <div class="info-right">
            <div class="total-count-box">Total: <span id="total-count-display" class="total-num">--</span></div>
            <div class="timer-box">â± <span id="timer-display">00:00</span></div>
        </div>
        <div id="progress-container"><div id="progress-bar"></div></div>
    </header>

    <main>
        <div class="grid-container">
            <div class="column">
                <div class="col-header">Word</div>
                <div id="col-en" style="display:grid; gap:10px;"></div>
            </div>
            <div class="column">
                <div class="col-header">Meaning</div>
                <div id="col-zh" style="display:grid; gap:10px;"></div>
            </div>
        </div>
        <div class="feedback-trigger">
            <span class="feedback-link" onclick="openFeedback()">âœï¸ æäº¤åé¦ˆ / è¯„ä»·</span>
        </div>
    </main>

    <footer>
        <button class="btn" id="next-btn" onclick="nextLevel()">ä¸‹ä¸€ç»„ (Next Level)</button>
    </footer>

    <script>
        // ================= CONFIG =================
        const WORD_API = "https://api.npoint.io/ef9cd015292eaa3ac09b"; 
        // æ›¿æ¢ä½ çš„ Formspree ID
        const FORMSPREE_ENDPOINT = "https://formspree.io/f/xjklqldr"; 
        // ==========================================

        let fullLibrary = []; let gamePool = []; let currentRound = []; 
        let matches = 0; let selectedEn = null, selectedZh = null; let isProcessing = false; 
        let totalAttempts = 0; let totalErrors = 0;
        let timerInterval = null; let secondsElapsed = 0;
        let currentRating = 5;

        // è¯­éŸ³ç›¸å…³å˜é‡
        let currentTargetWord = "";
        let recognition = null;
        let isListening = false;

        async function init() {
            const loadingText = document.getElementById('loading-text');
            try {
                loadingText.innerText = "æ­£åœ¨ä¸‹è½½æ•°æ®...";
                const res = await fetch(WORD_API);
                if(!res.ok) throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
                let data = await res.json();
                
                let dataArray = [];
                if (Array.isArray(data)) dataArray = data;
                else if (typeof data === 'object') dataArray = data.words || data.list || Object.values(data);
                
                fullLibrary = dataArray.map(item => {
                    let en, zh;
                    if(Array.isArray(item)) { en = item[0]; zh = item[1]; }
                    else { en = item.en; zh = item.zh; }
                    if(en) return { en: String(en).trim(), zh: zh ? String(zh).trim() : "æš‚æ— é‡Šä¹‰" };
                    return null;
                }).filter(i => i);

                document.getElementById('total-count-display').innerText = fullLibrary.length;
                document.getElementById('loading-screen').style.display = 'none';
                
                initStarRating();
                initSpeech(); // åˆå§‹åŒ–è¯­éŸ³åŠŸèƒ½
                startGame();

            } catch (err) {
                loadingText.innerHTML = `é”™è¯¯: ${err.message} <br><br> <u onclick="location.reload()">ç‚¹å‡»é‡è¯•</u>`;
            }
        }

        function startGame() {
            gamePool = JSON.parse(JSON.stringify(fullLibrary));
            shuffle(gamePool);
            updateStats();
            startTimer();
            loadLevel();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            secondsElapsed = 0;
            timerInterval = setInterval(() => {
                secondsElapsed++;
                const m = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
                const s = (secondsElapsed % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `${m}:${s}`;
            }, 1000);
        }

        // ==========================================
        // æ ¸å¿ƒï¼šè¯­éŸ³è·Ÿè¯» & æœ—è¯»åŠŸèƒ½
        // ==========================================
        function initSpeech() {
            // 1. æ£€æŸ¥æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US'; // è®¾å®šä¸ºç¾å¼è‹±è¯­
                recognition.continuous = false; // è¯´å®Œä¸€å¥å°±åœ
                recognition.interimResults = false;

                recognition.onstart = () => {
                    isListening = true;
                    updateMicUI(true);
                    document.getElementById('speak-msg').innerText = "æ­£åœ¨å¬...è¯·æœ—è¯»å•è¯";
                    document.getElementById('speak-msg').className = "speak-feedback";
                };

                recognition.onend = () => {
                    isListening = false;
                    updateMicUI(false);
                    if(document.getElementById('speak-msg').innerText.includes("æ­£åœ¨å¬")) {
                         document.getElementById('speak-msg').innerText = "æœªæ£€æµ‹åˆ°å£°éŸ³ï¼Œè¯·é‡è¯•";
                    }
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    checkPronunciation(transcript);
                };

                recognition.onerror = (event) => {
                    isListening = false;
                    updateMicUI(false);
                    console.error(event.error);
                    document.getElementById('speak-msg').innerText = "æ— æ³•è¯†åˆ«ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™";
                };
            } else {
                console.warn("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«");
            }
        }

        // æ’­æ”¾è¯»éŸ³ (TTS)
        function playAudio() {
            if (!currentTargetWord) return;
            // å–æ¶ˆä¹‹å‰çš„æœ—è¯»
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(currentTargetWord);
            utterance.lang = 'en-US';
            utterance.rate = 0.9; // ç¨å¾®æ…¢ä¸€ç‚¹ç‚¹ï¼Œæ¸…æ™°
            window.speechSynthesis.speak(utterance);
        }

        // åˆ‡æ¢è·Ÿè¯» (STT)
        function toggleSpeech() {
            if (!recognition) {
                alert("æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è·Ÿè¯»åŠŸèƒ½ (æ¨èä½¿ç”¨ Chrome / Android)ã€‚iOS ç”¨æˆ·è¯·å°è¯•ä½¿ç”¨ Safari æœ€æ–°ç‰ˆå¹¶æˆäºˆéº¦å…‹é£æƒé™ã€‚");
                return;
            }
            if (isListening) {
                recognition.stop();
            } else {
                // å¯åŠ¨å‰å…ˆæ’­æ”¾ä¸€æ¬¡æ ‡å‡†éŸ³ï¼Œè¾…åŠ©ç”¨æˆ·
                // playAudio(); 
                // å»¶è¿Ÿä¸€ç‚¹å¯åŠ¨å½•éŸ³ï¼Œé˜²æ­¢é‡‡é›†åˆ°ç³»ç»ŸTTSçš„å£°éŸ³
                // setTimeout(() => recognition.start(), 500);
                try {
                    recognition.start();
                } catch(e) {
                    recognition.stop(); // é˜²æ­¢é‡å¤å¯åŠ¨æŠ¥é”™
                    setTimeout(() => recognition.start(), 100);
                }
            }
        }

        function updateMicUI(active) {
            const btn = document.getElementById('mic-btn');
            if (active) btn.classList.add('listening');
            else btn.classList.remove('listening');
        }

        // æ ¸å¿ƒï¼šæ¯”å¯¹å‘éŸ³
        function checkPronunciation(userSpoke) {
            // ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œåªä¿ç•™å­—æ¯è¿›è¡Œæ¯”å¯¹
            const cleanTarget = currentTargetWord.toLowerCase().replace(/[^a-z]/g, '');
            const cleanUser = userSpoke.replace(/[^a-z]/g, '');

            console.log(`Target: ${cleanTarget}, User: ${cleanUser}`);

            // æ¨¡ç³ŠåŒ¹é…é€»è¾‘ (å…è®¸åŒ…å«å…³ç³»)
            const isMatch = cleanUser === cleanTarget || cleanUser.includes(cleanTarget) || cleanTarget.includes(cleanUser);

            const msgBox = document.getElementById('speak-msg');
            if (isMatch) {
                msgBox.innerHTML = `âœ… å‘éŸ³å‡†ç¡®! (è¯†åˆ«: "${userSpoke}")`;
                msgBox.className = "speak-feedback speak-success";
                // ç­”å¯¹éœ‡åŠ¨æç¤º
                if (navigator.vibrate) navigator.vibrate([50, 50, 100]);
            } else {
                msgBox.innerHTML = `âš ï¸ å†è¯•ä¸€æ¬¡ (è¯†åˆ«: "${userSpoke}")`;
                msgBox.className = "speak-feedback speak-fail";
            }
        }

        // æ‰“å¼€å•è¯å¡ç‰‡ (æŸ¥è¯æˆ–é•¿æŒ‰)
        function openWordModal(word, def) {
            currentTargetWord = word;
            document.getElementById('modal-word').innerText = word;
            document.getElementById('modal-def').innerText = def;
            document.getElementById('speak-msg').innerText = "ç‚¹å‡»éº¦å…‹é£å¼€å§‹è·Ÿè¯»";
            document.getElementById('speak-msg').className = "speak-feedback";
            updateMicUI(false);
            
            document.getElementById('word-modal').style.display = 'flex';
        }

        // ==========================================
        // é•¿æŒ‰åŠŸèƒ½å®ç° (Long Press)
        // ==========================================
        let pressTimer;
        function handleTouchStart(data) {
            if(data.type !== 'en') return; // åªæœ‰è‹±æ–‡å¡ç‰‡æ”¯æŒé•¿æŒ‰
            pressTimer = setTimeout(() => {
                // è·å–å®Œæ•´é‡Šä¹‰ï¼ˆå¯èƒ½éœ€è¦ä» fullLibrary æŸ¥æ‰¾ä»¥è·å¾—æœ€å…¨ä¿¡æ¯ï¼‰
                const fullInfo = fullLibrary.find(i => i.en === data.text) || data;
                openWordModal(fullInfo.en, fullInfo.zh);
                // é‡ç½®é€‰ä¸­çŠ¶æ€é˜²æ­¢è§¦å‘æ¸¸æˆåŒ¹é…
                resetSelection(); 
            }, 600); // é•¿æŒ‰ 600ms è§¦å‘
        }
        function handleTouchEnd() {
            clearTimeout(pressTimer);
        }
        function resetSelection() {
            const cards = document.querySelectorAll('.card');
            cards.forEach(c => c.classList.remove('selected'));
            selectedEn = null; selectedZh = null;
        }

        // ==========================================
        // æ¸¸æˆé€»è¾‘ & å…¶ä»–ä¿æŒä¸å˜
        // ==========================================
        function createCard(data) {
            const div = document.createElement('div');
            div.className = `card ${data.type}`;
            div.innerText = data.text;
            div.dataset.id = data.id;
            div.dataset.type = data.type;
            
            // ç‚¹å‡»äº‹ä»¶ (æ¸¸æˆåŒ¹é…)
            div.onclick = () => handleTap(div);

            // é•¿æŒ‰äº‹ä»¶ (å­¦ä¹ è·Ÿè¯») - ä»…é™ç§»åŠ¨ç«¯ä½“éªŒä¼˜åŒ–
            div.addEventListener('touchstart', () => handleTouchStart(data), {passive: true});
            div.addEventListener('touchend', handleTouchEnd);
            // ç”µè„‘ç«¯å³é”®è¾…åŠ©
            div.oncontextmenu = (e) => {
                e.preventDefault();
                if(data.type === 'en') {
                    const fullInfo = fullLibrary.find(i => i.en === data.text) || data;
                    openWordModal(fullInfo.en, fullInfo.zh);
                }
            };
            
            return div;
        }

        function handleTap(el) {
            if (isProcessing || el.classList.contains('matched') || el.classList.contains('selected')) return;
            if (navigator.vibrate) navigator.vibrate(5);
            el.classList.add('selected');
            if (el.dataset.type === 'en') {
                if (selectedEn) selectedEn.classList.remove('selected');
                selectedEn = el;
            } else {
                if (selectedZh) selectedZh.classList.remove('selected');
                selectedZh = el;
            }
            if (selectedEn && selectedZh) checkMatch();
        }

        function checkMatch() {
            isProcessing = true;
            const isMatch = selectedEn.dataset.id === selectedZh.dataset.id;
            totalAttempts++; if (!isMatch) totalErrors++;
            updateErrorStats();
            if (isMatch) {
                matches++;
                selectedEn.classList.replace('selected', 'matched');
                selectedZh.classList.replace('selected', 'matched');
                selectedEn = null; selectedZh = null; isProcessing = false;
                if (matches === currentRound.length) {
                    document.getElementById('next-btn').style.display = 'block';
                    setTimeout(() => { document.querySelector('main').scrollTo({ top: 9999, behavior: 'smooth' }); }, 200);
                }
            } else {
                selectedEn.classList.add('wrong'); selectedZh.classList.add('wrong');
                if (navigator.vibrate) navigator.vibrate(50);
                setTimeout(() => {
                    selectedEn.classList.remove('selected', 'wrong'); selectedZh.classList.remove('selected', 'wrong');
                    selectedEn = null; selectedZh = null; isProcessing = false;
                }, 400);
            }
        }

        function submitSearch() {
            const input = document.getElementById('search-input');
            const query = input.value.trim().toLowerCase();
            input.blur();
            if (!query) return;

            let result = fullLibrary.find(w => w.en.toLowerCase() === query);
            if (!result) result = fullLibrary.find(w => w.en.toLowerCase().startsWith(query));
            if (!result) result = fullLibrary.find(w => w.en.toLowerCase().includes(query));

            if (result) {
                openWordModal(result.en, result.zh);
            } else {
                alert(`æœªæ‰¾åˆ°å•è¯: ${query}`);
            }
            document.getElementById('search-input').value = '';
        }

        // ä¿æŒåŸæœ‰çš„åé¦ˆæäº¤ã€ç»Ÿè®¡ã€å…³å¡åŠ è½½ç­‰å‡½æ•°...
        function loadLevel() {
            document.getElementById('next-btn').style.display = 'none';
            matches = 0; selectedEn = null; selectedZh = null;
            if (gamePool.length === 0) { alert("æ­å–œï¼æ‰€æœ‰å•è¯å·²å®Œæˆï¼"); return; }
            const count = Math.min(8, gamePool.length);
            currentRound = gamePool.splice(0, count);
            updateStats();
            const colEn = document.getElementById('col-en'); const colZh = document.getElementById('col-zh');
            colEn.innerHTML = ''; colZh.innerHTML = '';
            let listEn = currentRound.map(i => ({id: i.en, text: i.en, type: 'en'}));
            let listZh = currentRound.map(i => ({id: i.en, text: i.zh, type: 'zh'}));
            shuffle(listEn); shuffle(listZh);
            listEn.forEach(d => colEn.appendChild(createCard(d)));
            listZh.forEach(d => colZh.appendChild(createCard(d)));
        }

        function updateErrorStats() {
            const el = document.getElementById('error-rate-display');
            el.innerText = `${totalErrors}/${totalAttempts}`;
            if (totalErrors > 0) el.classList.add('error-text');
        }
        function updateStats() {
            const total = fullLibrary.length;
            const pct = total > 0 ? ((total - gamePool.length) / total) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }
        function shuffle(arr) { arr.sort(() => Math.random() - 0.5); }
        function closeModal(id) {
             document.getElementById(id).style.display = 'none';
             if(id==='word-modal') { window.speechSynthesis.cancel(); if(recognition) recognition.stop(); }
        }
        
        // åé¦ˆåŠŸèƒ½å‡½æ•°
        function openFeedback() { 
            if (FORMSPREE_ENDPOINT.includes("YOUR_ID")) { alert("è¯·é…ç½® Formspree ID"); return; }
            document.getElementById('feedback-modal').style.display = 'flex'; 
        }
        function initStarRating() {
             const stars = document.querySelectorAll('#star-container span');
             stars.forEach(star => { star.onclick = function() { currentRating = parseInt(this.dataset.val); updateStars(); } });
             updateStars();
        }
        function updateStars() {
             const stars = document.querySelectorAll('#star-container span');
             stars.forEach(s => { if(parseInt(s.dataset.val) <= currentRating) s.classList.add('active'); else s.classList.remove('active'); });
        }
        async function submitFeedback() {
            const text = document.getElementById('feedback-text').value.trim();
            const btn = document.getElementById('submit-fb-btn');
            if(!text) { alert("è¯·å¡«å†™å†…å®¹"); return; }
            btn.disabled = true; btn.innerText = "å‘é€ä¸­...";
            try {
                const response = await fetch(FORMSPREE_ENDPOINT, {
                    method: 'POST', body: JSON.stringify({ rating: currentRating + "æ˜Ÿ", message: text, date: new Date().toLocaleString() }),
                    headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' }
                });
                if (response.ok) { alert("åé¦ˆå·²å‘é€ï¼"); document.getElementById('feedback-text').value = ''; closeModal('feedback-modal'); }
                else throw new Error("æäº¤å¤±è´¥");
            } catch (err) { alert(err.message); } finally { btn.disabled = false; btn.innerText = "æäº¤åé¦ˆ"; }
        }

        init();
    </script>
</body>
</html>
